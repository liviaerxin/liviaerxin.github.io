"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5968],{18306:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>m,contentTitle:()=>c,default:()=>p,frontMatter:()=>d,metadata:()=>l,toc:()=>u});var r=s(74848),a=s(28453),o=s(72170),t=s.n(o);const i='version: "3"\n\n# Inspired by https://github.com/dperson/samba/blob/master/docker-compose.yml\n\nservices:\n  samba:\n    image: dperson/samba\n    privileged: true\n    environment:\n      TZ: "EST5EDT"\n    ports:\n      - "137:137/udp"\n      - "138:138/udp"\n      - "139:139/tcp"\n      - "445:445/tcp"\n    volumes:\n      - mnt:/mnt:z\n    command: \'-s "Mount;/mnt;yes;no;yes" -u "bob;bobspasswd" -p\'\n    # networks:\n    #   default:\n    #     ipv4_address: 172.28.0.20\n\n  samba-client:\n    image: busybox\n    restart: on-failure\n    volumes:\n      - samba-volume:/smb_share\n    # tty: true\n    command: sleep infinity\n    depends_on:\n      - samba\n\n    # networks:\n    #   default:\n    #     ipv4_address: 172.28.0.21\n        \n# networks:\n#   default:\n#     driver: bridge\n#     ipam:\n#       config:\n#         - subnet: 172.28.0.0/16\n#           gateway: 172.28.0.1\n\nvolumes:\n  mnt:\n  samba-volume:\n    driver: local\n    driver_opts:\n      type: cifs\n      # device: "//172.28.0.20/Mount"\n      # o: "username=bob,password=bobspasswd"\n      device: "//localhost/Mount"\n      o: "addr=localhost,username=bob,password=bobspasswd"',d={authors:["frank"],tags:["docker","samba"],description:"Set Up Samba Server in Docker",keywords:["Set Up Samba Server in Docker"],image:"https://i.imgur.com/mErPwqL.png",date:new Date("2025-01-12T00:00:00.000Z"),draft:!1,enableComments:!0},c="Set Up Samba Server in Docker",l={id:"docker-setup-samba-server",title:"Set Up Samba Server in Docker",description:"Set Up Samba Server in Docker",source:"@site/../../docs/docker-setup-samba-server.mdx",sourceDirName:".",slug:"/docker-setup-samba-server",permalink:"/docs/docker-setup-samba-server",draft:!1,unlisted:!1,editUrl:"https://github.com/liviaerxin/liviaerxin.github.io/edit/master/_ssg/docusaurus/../../docs/docker-setup-samba-server.mdx",tags:[{inline:!0,label:"docker",permalink:"/docs/tags/docker"},{inline:!0,label:"samba",permalink:"/docs/tags/samba"}],version:"current",lastUpdatedBy:"liviaerxin",lastUpdatedAt:1744922238e3,frontMatter:{authors:["frank"],tags:["docker","samba"],description:"Set Up Samba Server in Docker",keywords:["Set Up Samba Server in Docker"],image:"https://i.imgur.com/mErPwqL.png",date:"2025-01-12T00:00:00.000Z",draft:!1,enableComments:!0},sidebar:"docs",previous:{title:"Set Up NFS Sever in Docker",permalink:"/docs/docker-setup-nfs-sever"},next:{title:"MDX Features of Docusaurus",permalink:"/docs/docusaurus-mdx-features"}},m={},u=[{value:"Start Samba Server in Docker",id:"start-samba-server-in-docker",level:2},{value:"Start Samba Client in Docker",id:"start-samba-client-in-docker",level:2},{value:"Start Samba Client which Create Volume in Docker",id:"start-samba-client-which-create-volume-in-docker",level:2},{value:"Use Case in Docker Compose",id:"use-case-in-docker-compose",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"set-up-samba-server-in-docker",children:"Set Up Samba Server in Docker"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"!IMPORTANT"}),": Permission setting is very annoying but critical, sometimes you need take long time to fine tune it and debug.\n",(0,r.jsx)(n.strong,{children:"!IMPORTANT"}),": When setting up a Samba server in Docker in OSX, you will encounter problems such as ",(0,r.jsx)(n.code,{children:"Operation not suppored"})," when using ",(0,r.jsx)(n.code,{children:"bind mount"}),". Roughly saying, the reason is Docker run in a light VM in Mac and your Mac host uses a different file system(HFS+) compared to Linux(ext4 or similar). So switching to ",(0,r.jsx)(n.code,{children:"volume mount"})," will solve this potential problem."]}),"\n",(0,r.jsx)(n.p,{children:"Some takeaways about Permission:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Creating and deleting files is controlled by permissions on the directory."}),"\n",(0,r.jsx)(n.li,{children:"Modifying the file is controlled by permissions on the file. You may have a mask which is removing the write privilege from the file."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When I turned to set up Samba server locally, the main purpose is that I would like to integrate the Samba server into my Docker Compose project to mock a real remote Samba server, which will facilitate your local development in Docker environment."}),"\n",(0,r.jsx)(n.p,{children:"So this blog will illustrate to set up a Samba server and a client, and test interaction between them."}),"\n",(0,r.jsx)(n.h2,{id:"start-samba-server-in-docker",children:"Start Samba Server in Docker"}),"\n",(0,r.jsxs)(n.p,{children:["Here, we use Samba server image from ",(0,r.jsx)(n.a,{href:"https://hub.docker.com/r/dperson/samba",children:"dperson/samba"}),". Although there is an alternative from ",(0,r.jsx)(n.a,{href:"https://hub.docker.com/r/servercontainers/samba",children:"ghcr.io/servercontainers/samba"})," or ",(0,r.jsx)(n.a,{href:"https://github.com/crazy-max/docker-samba",children:"crazymax/samba"})]}),"\n",(0,r.jsxs)(n.p,{children:["In OSX, it's critical to use ",(0,r.jsx)(n.code,{children:"volume mount"})," and avoid using ",(0,r.jsx)(n.code,{children:"bind mount"})," as we mentioned above."]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.p,{children:["In OSX, due to the docker desktop itself is running in VM, it will cause some error like ",(0,r.jsx)(n.code,{children:"Operation not supported"})," when binding a local file folder via ",(0,r.jsx)(n.code,{children:"bind mount"})," even you set ",(0,r.jsx)(n.code,{children:"777"})," mask on the folder. So it's recommended to use ",(0,r.jsx)(n.code,{children:"volume mount"})," to bind to ",(0,r.jsx)(n.code,{children:"/mnt"})," in Samba server in OSX."]}),(0,r.jsxs)(n.p,{children:["Furthermore, the Samba server will log such message: ",(0,r.jsx)(n.code,{children:"error reading meta xattr: Not supported"}),"."]})]}),"\n",(0,r.jsxs)(n.p,{children:["In Linux, it's okay to use either ",(0,r.jsx)(n.code,{children:"volume mount"})," or ",(0,r.jsx)(n.code,{children:"bind mount"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'docker run -it --rm \\\n    --name samba \\\n    -p 139:139 -p 445:445 \\\n    -v mnt:/mnt:z \\\n    dperson/samba \\\n    -p -s "Mount;/mnt;yes;no;yes" -u "bob;bobspasswd" -g "log level = 5"\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:'-s "<Mount;/mnt>;yes;no;yes"'})," means [browsable",":yes",";readonly",":no",";guest",":yes",']", which will allow the guest to ',(0,r.jsx)(n.code,{children:"read"})," and the user to ",(0,r.jsx)(n.code,{children:"read/write"}),"!"]})}),"\n",(0,r.jsx)(n.p,{children:"Get the samba server IP address:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"$ docker inspect \\\n    -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' \\\n    samba\n172.17.0.2\n"})}),"\n",(0,r.jsx)(n.h2,{id:"start-samba-client-in-docker",children:"Start Samba Client in Docker"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"dperson/samba"})," or ",(0,r.jsx)(n.code,{children:"busybox"})," image,"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"docker run -it --rm --privileged dperson/samba bash\n"})}),"\n",(0,r.jsx)(n.p,{children:"or"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"docker run -it --rm --privileged busybox sh\n"})}),"\n",(0,r.jsx)(n.p,{children:"Inside the container:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'mkdir /smb_share\n\n# mount -t cifs //[server-ip]/[share-path] /[mount-point]\nmount -t cifs //172.17.0.2/Mount /smb_share -o rw,username=bob,password=bobspasswd\n\n# write file\necho "xxxx" > /smb_share/f.txt\n'})}),"\n",(0,r.jsx)(n.h2,{id:"start-samba-client-which-create-volume-in-docker",children:"Start Samba Client which Create Volume in Docker"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Create a CIFS/Samba Volume"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"docker volume create \\\n    --driver local \\\n    --opt type=cifs \\\n    --opt device=//172.17.0.2/Mount \\\n    --opt o=username=bob,password=bobspasswd \\\n    --name samba-volume\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:'$ docker inspect samba-volume\n[\n    {\n        "CreatedAt": "2023-08-13T16:24:03Z",\n        "Driver": "local",\n        "Labels": null,\n        "Mountpoint": "/var/lib/docker/volumes/samba-volume/_data",\n        "Name": "samba-volume",\n        "Options": {\n            "device": "//172.17.0.2/Mount",\n            "o": "addr=username=bob,password=bobspasswd",\n            "type": "cifs"\n        },\n        "Scope": "local"\n    }\n]\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["Start a container using the created volume ",(0,r.jsx)(n.code,{children:"samba-volume"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"docker run -it --rm \\\n    -v samba-volume:/mnt \\\n    busybox \\\n    sh\n"})}),"\n",(0,r.jsx)(n.h2,{id:"use-case-in-docker-compose",children:"Use Case in Docker Compose"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:s(3917).A+""})}),"\n","\n",(0,r.jsx)(t(),{language:"yaml",title:"docker-compose-samba.yml",children:i}),"\n",(0,r.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(n.p,{children:["When you mount an Samba Share in Linux, you may encounter error like ",(0,r.jsx)(n.code,{children:"failed: Invalid argument"}),","]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"bash-5.1# mount -t cifs //172.17.0.2/Mount /mnt/smb_share -o iocharset=utf8,rw,vers=1.0\nmount: mounting //172.17.0.2/Mount on /mnt/smb_share failed: Invalid argument\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can use ",(0,r.jsx)(n.code,{children:"dmesg"})," to debug,"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sh",children:"bash-5.1# dmesg\n[317258.750535] CIFS: Attempting to mount \\\\172.17.0.2\\Mount\n[317258.752956] CIFS: VFS: No username specified\n[317336.240984] cifs: Unknown parameter 'passwd'\n[317344.451345] CIFS: Attempting to mount \\\\172.17.0.2\\Mount\n"})})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},3917:(e,n,s)=>{s.d(n,{A:()=>r});const r=s.p+"assets/files/docker-compose-b20a9747a47a6ca1f96d665429f7ce84.yml"}}]);